
<div id='temperature-slider' class='control side-column'>
  <div class='temps'>
    { actual } / { sliderTemp }
  </div>
  <div ref:track id='slider-track'>
    <div id='handle' draggable=true on:dragstart="dragstart(event)" on:drag="drag(event)" on:dragend="dragend(event)" style='top: {handlePosition}%;'></div>
  </div>
  <div class='name'>
    {name}
  </div>
</div>

<style>
  #temperature-slider {
    height: 100vh;
    font-size: 4.5vh;
    text-align: center;
    position: relative;
  }

  #temperature-slider .temps {
    top: 1vh;
    position: absolute;
    width: 100%;
  }

  #temperature-slider .name {
    bottom: 0;
    position: absolute;
    width: 100%;
  }

  #slider-track {
    position: absolute;
    top: 7vh;
    left: 12vh;
    width: 1vh;
    height: 85vh;
    background-color: rgb(24,38,58);
  }

  #handle {
    position: relative;
    width: 11vh;
    height: 5vh;
    left: -5vh;
    box-shadow: inset 0 0 1px #54958A, inset 0 0 20px #465468;
    background: rgba(44,58,78,0.8);
  }
</style>

<script>
    import store from './stores/AppDataStore.js';
    import { setTemp } from './rest/OctoConnection.js';
    import { runJob } from './stores/StoreManager.js';

    export default {
      store: () => store,
      data: () => ({
        key: false,
        sliderTemp: 0,
        name: ''
      }),
      onstate({changed,current}) {
        if(changed.key) {
          const sliderTemp = store.get().printerState.temperature[current.key].target;
          const name = store.get().conf.temperatureControls.find((control)=> control.key === current.key).name;
          this.set({sliderTemp, name});
        }
      },
      computed: { 
        actual({$printerState, key}) {
          return $printerState.temperature[key].actual;
        }, 
        handlePosition({sliderTemp}) {
          return 100-(sliderTemp/300*100)-2.5
        }
      },
      methods: {
        drag({y}){
          if(y==0) {return;}
          let sliderPos = 1-(y-this.refs.track.offsetTop)/this.refs.track.clientHeight
          sliderPos = sliderPos < 1 ? sliderPos : 1;
          sliderPos = sliderPos > 0 ? sliderPos : 0;   
          this.set({sliderTemp: Math.floor(sliderPos*300)});
        },
        dragstart(e) {
          e.dataTransfer.setDragImage(document.createElement('img'), 0, 0);
        },
        dragend(e) {
          const { key, sliderTemp } = this.get();
          setTemp(key, sliderTemp)
            .then( () => runJob('printerState'));
        },
      }
    }
</script>
