
<div id=app>
  <PowerBar/>
  {#if $connectionState.current.state === 'Closed'}
    <PrinterConnectionDialog/>
  {/if}
  {#if $connectionState.current.state === 'Operational'}
    <div class='center-column'>
      {#if $activeTemperatureButton}
        <TemperatureSlider key={$activeTemperatureButton}/>
      {/if}
    </div>
      <PrinterBar/>
  {/if}
</div>
<div id="perspective">
  <div id="pane">
    <Cube height=0 pulse='true'/>
    <Cube height=100/>
  </div>
</div>
<TemperatureChart/> 


<style>
  #app {
    width: 100vw;
    height: 100vh;
    display: flex;
    flex-flow: row nowrap;
    align-items: stretch;
  }

  #error {
      bottom: 0;
      position: absolute;
      font-size: 3em;
      color: rgb(83, 17, 17);
  }
    
  #perspective {
    position: fixed;
    z-index: -5;
    left:50vw; top:50vh;
    width: 50vh;
    height: 50vh;
    margin-left: -25vh;
    margin-top: -25vh;
  }

  #pane {
    width:100%; height:100%;
    transform-style: preserve-3d;
    transform: rotateX(-35.27deg);
  }

</style>


<script>
  import store from './stores/AppDataStore.js';
  import { addJob } from './stores/StoreManager.js';
  import { ConfJob, Md5Job, ApiVersionJob, ConnectionStateJob, PrinterStateJob, OutputStatesJob } from './jobs';
 
  addJob(new ConfJob(store));
  addJob(new Md5Job(store));
  addJob(new ApiVersionJob(store));
  addJob(new ConnectionStateJob(store));
  addJob(new PrinterStateJob(store));
  addJob(new OutputStatesJob(store));

  export default {
    store: () => store,
    data: () => ({
      md5sum: false,
    }),
    components: { 
        PowerBar: './PowerBar.html', 
        Cube: './Cube.html',
        PrinterBar: './PrinterBar.html',
        PrinterConnectionDialog: './PrinterConnectionDialog.html',
        TemperatureChart: './TemperatureChart.html',
        TemperatureSlider: './TemperatureSlider.html'
    },
    oncreate() {
			const listener = this.store.on('state', ({ current }) => {
        if( !current.appMd5 ) {
          return;
        }
        if( !this.get().md5sum ) {
          this.set(current.appMd5);
        }
        if( this.get().md5sum !== current.appMd5.md5sum ){
          window.location.reload();
        } 
      });
      this.on('destroy', listener.cancel);
    }
  }

</script>