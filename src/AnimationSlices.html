<script>

  import { MeshPhongMaterial, Mesh } from 'three';
 
  const blueSolid = new MeshPhongMaterial( { color: 0x156289, flatShading: true } );
  const blueTrans = new MeshPhongMaterial( { color: 0x156289, opacity: 0.05, transparent: true, flatShading: true } );
  const redSolid = new MeshPhongMaterial( { color: 0x891528, flatShading: true } );

  export default {
    data: () => ({}),
    methods: {
      currentLayer() {
        return Math.floor(this.get().showPercentage || 50);
      },
      updateSlices() {
        const group = this.get().group;
        this.get().slices
          .forEach( (geometry,i) => {
            const current = group.getObjectByName(geometry.name);
            if(current) {
              current.geometry = geometry;
            }else{
              const [ num, key ] = geometry.name.split('-');
              const mesh = new Mesh( geometry, key == 'bottom' ? blueSolid: redSolid );
              mesh.name = geometry.name;
              mesh.visible = false;
              group.add(mesh);
            }
          });
      },
      updateVisibility() {
        const current = this.currentLayer();
        this.get().group.children.forEach( (mesh) => {
          const [ num, key ] = mesh.name.split('-');
          const i = parseInt(num);
          if(i == current) {
            mesh.visible = true;
          }else{
            mesh.visible = false;
          }
          

        });
      }
    },
    onstate({changed}) {
      console.log({changed});
      if(changed.slices === true) {
        this.updateSlices();
      }
      if(changed.showPercentage === true || changed.slices === true){
        this.updateVisibility();
      }
    },
    oncreate() {
      console.log('create');
      this.updateSlices();
      console.log('update done');
      this.updateVisibility();
      console.log('vis done')
    }
  }
</script>